<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>MIREA Attendance Mini App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Telegram WebApp JS -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body class="bg-slate-950 min-h-screen flex justify-center">
  <div
    id="app"
    class="w-full max-w-lg px-4 py-6 sm:px-6 sm:py-8 text-slate-50 font-sans"
  >
    <!-- HEADER -->
    <header class="mb-6">
      <h1 class="text-2xl font-bold tracking-tight mb-1">
        MIREA Attendance
      </h1>
      <p class="text-sm text-slate-300">
        –ú–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –æ—Ç–º–µ—Ç–æ–∫ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏: —Å—Ç—É–¥–µ–Ω—Ç ¬∑ —Å–ø–∏–∫–µ—Ä ¬∑ –º–∞—Å—Ç–µ—Ä-–∞–¥–º–∏–Ω.
      </p>

      <div
        id="userInfo"
        class="mt-4 flex items-center justify-between bg-slate-900/60 border border-slate-800 rounded-xl px-3 py-2 text-xs"
      >
        <div>
          <div id="tgName" class="font-semibold">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å Telegram</div>
          <div id="tgUid" class="text-slate-400">ID: ‚Äî</div>
        </div>
        <span
          id="tgRoleLabel"
          class="inline-flex items-center px-2 py-1 rounded-full text-[10px] font-semibold bg-sky-500/10 text-sky-300 border border-sky-500/40"
        >
          –†–æ–ª—å: –°—Ç—É–¥–µ–Ω—Ç
        </span>
      </div>
    </header>

    <!-- ROLE SWITCHER -->
    <nav
      class="grid grid-cols-3 gap-2 bg-slate-900/60 border border-slate-800 rounded-2xl p-1 mb-4 text-xs font-semibold"
    >
      <button
        data-role-btn="student"
        class="role-btn rounded-xl px-3 py-2 bg-sky-500 text-white shadow-sm"
      >
        –°—Ç—É–¥–µ–Ω—Ç
      </button>
      <button
        data-role-btn="speaker"
        class="role-btn rounded-xl px-3 py-2 text-slate-200 hover:bg-slate-800/80"
      >
        –°–ø–∏–∫–µ—Ä
      </button>
      <button
        data-role-btn="admin"
        class="role-btn rounded-xl px-3 py-2 text-slate-200 hover:bg-slate-800/80"
      >
        –ú–∞—Å—Ç–µ—Ä-–∞–¥–º–∏–Ω
      </button>
    </nav>

    <!-- STATUS BAR -->
    <section
      id="statusBar"
      class="mb-4 bg-slate-900/60 border border-slate-800 rounded-2xl px-3 py-2 text-xs text-slate-300"
    >
      <div id="statusMain" class="font-semibold text-slate-100">
        –ì–æ—Ç–æ–≤–æ –∫ —Ä–∞–±–æ—Ç–µ.
      </div>
      <div id="statusSecondary" class="text-[11px] text-slate-400 mt-1">
        –°–æ–æ–±—â–µ–Ω–∏—è –∏ —Å–æ–±—ã—Ç–∏—è –±—É–¥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å—Å—è —á–µ—Ä–µ–∑ Telegram.WebApp.sendData().
      </div>
    </section>

    <!-- PANELS WRAPPER -->
    <main class="space-y-4 mb-8">

      <!-- STUDENT PANEL -->
      <section
        id="panel-student"
        data-role-panel="student"
        class="bg-slate-900/80 border border-slate-800 rounded-2xl p-4 space-y-4"
      >
        <h2 class="text-sm font-semibold text-slate-100 mb-1">
          –ü–∞–Ω–µ–ª—å —Å—Ç—É–¥–µ–Ω—Ç–∞
        </h2>
        <p class="text-xs text-slate-400 mb-2">
          –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å, –æ—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR –ª–µ–∫—Ü–∏–∏, –≤–∫–ª—é—á–∏—Ç–µ —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏—é
          –≥–µ–æ–ø–æ–∑–∏—Ü–∏–∏ –∏ –æ—Ç–º–µ—Ç—å—Ç–µ—Å—å.
        </p>

        <!-- –ü—Ä–æ—Ñ–∏–ª—å -->
        <div class="space-y-2">
          <h3 class="text-xs font-semibold text-slate-300">
            –ü—Ä–æ—Ñ–∏–ª—å –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
          </h3>
          <input
            id="studentFio"
            type="text"
            placeholder="–§–∞–º–∏–ª–∏—è –ò–º—è –û—Ç—á–µ—Å—Ç–≤–æ"
            class="w-full rounded-xl border border-slate-700 bg-slate-950/60 px-3 py-2 text-xs placeholder:text-slate-500 focus:outline-none focus:ring-1 focus:ring-sky-500"
          />
          <input
            id="studentEmail"
            type="email"
            placeholder="–ü–æ—á—Ç–∞ @edu.mirea.ru"
            class="w-full rounded-xl border border-slate-700 bg-slate-950/60 px-3 py-2 text-xs placeholder:text-slate-500 focus:outline-none focus:ring-1 focus:ring-sky-500"
          />
          <button
            id="btnStudentRegister"
            class="w-full mt-1 inline-flex justify-center items-center gap-1 rounded-xl bg-sky-500 hover:bg-sky-600 text-xs font-semibold py-2.5"
          >
            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å / –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
          </button>
        </div>

        <hr class="border-slate-800 my-2" />

        <!-- QR –∏ –ª–µ–∫—Ü–∏—è -->
        <div class="space-y-2">
          <h3 class="text-xs font-semibold text-slate-300">
            QR-–∫–æ–¥ –∏ –ª–µ–∫—Ü–∏—è
          </h3>
          <button
            id="btnStudentScanQR"
            class="w-full inline-flex justify-center items-center gap-2 rounded-xl bg-purple-600 hover:bg-purple-700 text-xs font-semibold py-2.5"
          >
            üì∑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR –ª–µ–∫—Ü–∏–∏
          </button>
          <p
            id="studentLectureInfo"
            class="text-[11px] text-slate-400 mt-1 break-words"
          >
            –õ–µ–∫—Ü–∏—è –µ—â—ë –Ω–µ –≤—ã–±—Ä–∞–Ω–∞. –û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥, —á—Ç–æ–±—ã –ø—Ä–∏–≤—è–∑–∞—Ç—å—Å—è –∫
            –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –ø–∞—Ä–µ.
          </p>
        </div>

        <hr class="border-slate-800 my-2" />

        <!-- Live GEO -->
        <div class="space-y-2">
          <h3 class="text-xs font-semibold text-slate-300">
            –¢—Ä–∞–Ω—Å–ª—è—Ü–∏—è –≥–µ–æ–ø–æ–∑–∏—Ü–∏–∏ (live)
          </h3>
          <p class="text-[11px] text-slate-400">
            –ü—Ä–∏ –≤–∫–ª—é—á–µ–Ω–∏–∏ –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º <b>watchPosition()</b> –∏ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏
            –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –±–æ—Ç—É. –≠—Ç–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø—Ä–∏–±–ª–∏–∂–µ–Ω–æ –∫
            —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏–∏ –≥–µ–æ–ø–æ–∑–∏—Ü–∏–∏ –≤ Telegram.
          </p>

          <div class="flex gap-2">
            <button
              id="btnGeoStart"
              class="flex-1 inline-flex justify-center items-center gap-1 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-xs font-semibold py-2.5 disabled:bg-emerald-900/60 disabled:text-emerald-200/60"
            >
              ‚ñ∂Ô∏è –í–∫–ª—é—á–∏—Ç—å —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏—é
            </button>
            <button
              id="btnGeoStop"
              class="flex-1 inline-flex justify-center items-center gap-1 rounded-xl bg-rose-600 hover:bg-rose-700 text-xs font-semibold py-2.5 disabled:bg-rose-900/60 disabled:text-rose-200/60"
              disabled
            >
              ‚èπ –í—ã–∫–ª—é—á–∏—Ç—å
            </button>
          </div>

          <div
            id="geoStatusBox"
            class="mt-1 text-[11px] text-slate-400 space-y-0.5"
          >
            <div id="geoStatusMain">–¢—Ä–∞–Ω—Å–ª—è—Ü–∏—è –≤—ã–∫–ª—é—á–µ–Ω–∞.</div>
            <div id="geoStatusLast">–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: ‚Äî</div>
          </div>
        </div>

        <hr class="border-slate-800 my-2" />

        <!-- –û—Ç–º–µ—Ç–∏—Ç—å—Å—è -->
        <div class="space-y-2">
          <h3 class="text-xs font-semibold text-slate-300">
            –û—Ç–º–µ—Ç–∏—Ç—å—Å—è –Ω–∞ –ª–µ–∫—Ü–∏–∏
          </h3>
          <button
            id="btnStudentCheckin"
            class="w-full inline-flex justify-center items-center gap-1 rounded-xl bg-blue-600 hover:bg-blue-700 text-xs font-semibold py-2.5"
          >
            ‚úÖ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–º–µ—Ç–∫—É
          </button>
          <p class="text-[11px] text-slate-400">
            –û—Ç–º–µ—Ç–∫–∞ —É–π–¥—ë—Ç –±–æ—Ç—É –≤–º–µ—Å—Ç–µ —Å —Ç–µ–∫—É—â–µ–π —Ä–æ–ª—å—é, –ø—Ä–æ—Ñ–∏–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π,
            ID –ª–µ–∫—Ü–∏–∏ –∏ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≥–µ–æ–ø–æ–∑–∏—Ü–∏–µ–π (–µ—Å–ª–∏ —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏—è –≤–∫–ª—é—á–µ–Ω–∞).
          </p>
        </div>
      </section>

      <!-- SPEAKER PANEL -->
      <section
        id="panel-speaker"
        data-role-panel="speaker"
        class="hidden bg-slate-900/80 border border-slate-800 rounded-2xl p-4 space-y-4"
      >
        <h2 class="text-sm font-semibold text-slate-100 mb-1">
          –ü–∞–Ω–µ–ª—å —Å–ø–∏–∫–µ—Ä–∞
        </h2>
        <p class="text-xs text-slate-400 mb-2">
          –û—Ç–∫—Ä—ã–≤–∞–π—Ç–µ/–∑–∞–∫—Ä—ã–≤–∞–π—Ç–µ –ª–µ–∫—Ü–∏–∏, –∑–∞–¥–∞–≤–∞–π—Ç–µ –≥–µ–æ–∑–æ–Ω—É –∞—É–¥–∏—Ç–æ—Ä–∏–∏, —É–ø—Ä–∞–≤–ª—è–π—Ç–µ
          –æ—Ç–º–µ—Ç–∫–∞–º–∏.
        </p>

        <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª–µ–∫—Ü–∏–µ–π -->
        <div class="space-y-2">
          <h3 class="text-xs font-semibold text-slate-300">–õ–µ–∫—Ü–∏—è</h3>
          <input
            id="speakerLectureId"
            type="text"
            placeholder="ID –ª–µ–∫—Ü–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, LEC123)"
            class="w-full rounded-xl border border-slate-700 bg-slate-950/60 px-3 py-2 text-xs placeholder:text-slate-500 focus:outline-none focus:ring-1 focus:ring-sky-500"
          />
          <div class="flex gap-2">
            <button
              id="btnSpeakerOpenLecture"
              class="flex-1 inline-flex justify-center items-center gap-1 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-xs font-semibold py-2.5"
            >
              üîì –û—Ç–∫—Ä—ã—Ç—å –æ—Ç–º–µ—Ç–∫—É
            </button>
            <button
              id="btnSpeakerCloseLecture"
              class="flex-1 inline-flex justify-center items-center gap-1 rounded-xl bg-rose-600 hover:bg-rose-700 text-xs font-semibold py-2.5"
            >
              üîí –ó–∞–∫—Ä—ã—Ç—å
            </button>
          </div>
          <p class="text-[11px] text-slate-400">
            –ë–æ—Ç –±—É–¥–µ—Ç —Ä–µ—à–∞—Ç—å, –∫–∞–∫–æ–π QR –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –∏ –∫–∞–∫–∏–µ –æ—Ç–º–µ—Ç–∫–∏ –ø—Ä–∏–Ω–∏–º–∞—Ç—å.
          </p>
        </div>

        <hr class="border-slate-800 my-2" />

        <!-- –ì–µ–æ–∑–æ–Ω–∞ -->
        <div class="space-y-2">
          <h3 class="text-xs font-semibold text-slate-300">
            –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –ª–µ–∫—Ü–∏–∏
          </h3>
          <button
            id="btnSpeakerSetGeo"
            class="w-full inline-flex justify-center items-center gap-1 rounded-xl bg-indigo-600 hover:bg-indigo-700 text-xs font-semibold py-2.5"
          >
            üìç –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≥–µ–æ–∑–æ–Ω—É –ø–æ —Ç–µ–∫—É—â–µ–π –ø–æ–∑–∏—Ü–∏–∏
          </button>
          <p class="text-[11px] text-slate-400">
            –û–¥–Ω–æ—Ä–∞–∑–æ–≤–æ –±–µ—Ä—ë–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏—Ö –±–æ—Ç—É –∫–∞–∫ —Ü–µ–Ω—Ç—Ä –¥–æ–ø—É—Å—Ç–∏–º–æ–≥–æ
            —Ä–∞–¥–∏—É—Å–∞.
          </p>
        </div>

        <hr class="border-slate-800 my-2" />

        <!-- QR-–ø–æ–¥—Å–∫–∞–∑–∫–∞ -->
        <div class="space-y-1">
          <h3 class="text-xs font-semibold text-slate-300">
            QR-–∫–æ–¥ –ª–µ–∫—Ü–∏–∏
          </h3>
          <p class="text-[11px] text-slate-400">
            QR-–∫–æ–¥ –¥–æ–ª–∂–µ–Ω –≤–µ—Å—Ç–∏ –Ω–∞ —Å—Å—ã–ª–∫—É –≤–∏–¥–∞:
            <span class="text-slate-200">
              <code>https://t.me/&lt;–±–æ—Ç&gt;/app?startapp=&lt;ID_–ª–µ–∫—Ü–∏–∏&gt;</code>
            </span>.
            –°—Ç—É–¥–µ–Ω—Ç—ã —Å–∫–∞–Ω–∏—Ä—É—é—Ç –µ–≥–æ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–º —Å–∫–∞–Ω–µ—Ä–æ–º –≤ —ç—Ç–æ–º WebApp.
          </p>
        </div>
      </section>

      <!-- ADMIN PANEL -->
      <section
        id="panel-admin"
        data-role-panel="admin"
        class="hidden bg-slate-900/80 border border-slate-800 rounded-2xl p-4 space-y-4"
      >
        <h2 class="text-sm font-semibold text-slate-100 mb-1">
          –ü–∞–Ω–µ–ª—å –º–∞—Å—Ç–µ—Ä-–∞–¥–º–∏–Ω–∞
        </h2>
        <p class="text-xs text-slate-400 mb-2">
          –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —á–∞—Ç–æ–≤, –∑–∞–ø—Ä–æ—Å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏, —Ä—É—á–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
          —Ä–æ–ª—è–º–∏ (–≤—Å—ë –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –±–æ—Ç–∞, –º—ã —Ç–æ–ª—å–∫–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–±—ã—Ç–∏—è).
        </p>

        <div class="space-y-2">
          <h3 class="text-xs font-semibold text-slate-300">
            –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–æ–ª—è–º–∏
          </h3>
          <input
            id="adminTargetUserId"
            type="number"
            placeholder="Telegram user_id"
            class="w-full rounded-xl border border-slate-700 bg-slate-950/60 px-3 py-2 text-xs placeholder:text-slate-500 focus:outline-none focus:ring-1 focus:ring-sky-500"
          />
          <select
            id="adminTargetRole"
            class="w-full rounded-xl border border-slate-700 bg-slate-950/60 px-3 py-2 text-xs focus:outline-none focus:ring-1 focus:ring-sky-500"
          >
            <option value="student">student</option>
            <option value="speaker">speaker</option>
            <option value="rating">rating</option>
            <option value="admin">admin</option>
          </select>
          <button
            id="btnAdminSetRole"
            class="w-full inline-flex justify-center items-center gap-1 rounded-xl bg-sky-500 hover:bg-sky-600 text-xs font-semibold py-2.5"
          >
            üë§ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
          </button>
        </div>

        <hr class="border-slate-800 my-2" />

        <div class="space-y-2">
          <h3 class="text-xs font-semibold text-slate-300">
            –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ª–µ–∫—Ü–∏–∏
          </h3>
          <input
            id="adminStatsLectureId"
            type="text"
            placeholder="ID –ª–µ–∫—Ü–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, LEC123)"
            class="w-full rounded-xl border border-slate-700 bg-slate-950/60 px-3 py-2 text-xs placeholder:text-slate-500 focus:outline-none focus:ring-1 focus:ring-sky-500"
          />
          <button
            id="btnAdminRequestStats"
            class="w-full inline-flex justify-center items-center gap-1 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-xs font-semibold py-2.5"
          >
            üìä –ó–∞–ø—Ä–æ—Å–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏
          </button>
          <p class="text-[11px] text-slate-400">
            –ë–æ—Ç –º–æ–∂–µ—Ç –ø—Ä–∏—Å–ª–∞—Ç—å —Å–≤–æ–¥–∫—É, –≤—ã–≥—Ä—É–∑–∫—É –≤ Google Sheets –∏–ª–∏ PDF-–æ—Ç—á—ë—Ç –≤
            –æ—Ç–¥–µ–ª—å–Ω—ã–π —á–∞—Ç.
          </p>
        </div>
      </section>
    </main>

    <!-- FOOTER -->
    <footer class="text-[10px] text-slate-500 text-center">
      –í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ (–≥–µ–æ–∑–æ–Ω–∞, —Ä–æ–ª–∏, —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞, –≤–∞–ª–∏–¥–∞—Ü–∏—è
      QR –∏ —Ç.–ø.) –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –±–æ—Ç–∞ –∏ —Å–µ—Ä–≤–µ—Ä–∞.
    </footer>
  </div>

  <script>
    // ------------------------------
    //  –ë–ê–ó–û–í–ê–Ø –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
    // ------------------------------
    const tg = window.Telegram?.WebApp;

    if (tg) {
      tg.ready();
      tg.expand();
    }

    const state = {
      role: "student",
      lectureId: null,
      geoWatchId: null,
      lastGeo: null,
    };

    const $ = (id) => document.getElementById(id);

    function setStatus(main, secondary) {
      if (main) $("statusMain").textContent = main;
      if (secondary) $("statusSecondary").textContent = secondary;
    }

    // ------------------------------
    //  –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –ò–ù–§–´ TELEGRAM
    // ------------------------------
    (function initTelegramUser() {
      if (!tg) return;

      const user = tg.initDataUnsafe?.user;
      if (user) {
        $("tgName").textContent =
          (user.first_name || "") + " " + (user.last_name || "");
        $("tgUid").textContent = "ID: " + user.id;
      }

      // –°–≤–µ—Ç–ª–∞—è/—Ç—ë–º–Ω–∞—è —Ç–µ–º–∞
      const isDark = tg.colorScheme === "dark";
      if (!isDark) {
        // —á—É—Ç—å –æ—Å–≤–µ—Ç–ª–∏–º —Ñ–æ–Ω, –µ—Å–ª–∏ –¢–µ–ª–µ–≥–∞ —Å–≤–µ—Ç–ª–∞—è
        document.body.classList.remove("bg-slate-950");
        document.body.classList.add("bg-slate-100");
      }
    })();

    // ------------------------------
    //  –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –†–û–õ–ï–ô
    // ------------------------------
    function updateRoleUI() {
      document
        .querySelectorAll("[data-role-panel]")
        .forEach((panel) => (panel.classList.add("hidden")));

      const activePanel = document.querySelector(
        `[data-role-panel="${state.role}"]`
      );
      if (activePanel) activePanel.classList.remove("hidden");

      document.querySelectorAll(".role-btn").forEach((btn) => {
        if (btn.dataset.roleBtn === state.role) {
          btn.classList.add("bg-sky-500", "text-white", "shadow-sm");
          btn.classList.remove("hover:bg-slate-800/80", "text-slate-200");
        } else {
          btn.classList.remove("bg-sky-500", "text-white", "shadow-sm");
          btn.classList.add("hover:bg-slate-800/80", "text-slate-200");
        }
      });

      $("tgRoleLabel").textContent =
        "–†–æ–ª—å: " +
        (state.role === "student"
          ? "–°—Ç—É–¥–µ–Ω—Ç"
          : state.role === "speaker"
          ? "–°–ø–∏–∫–µ—Ä"
          : "–ú–∞—Å—Ç–µ—Ä-–∞–¥–º–∏–Ω");
    }

    document.querySelectorAll("[data-role-btn]").forEach((btn) => {
      btn.addEventListener("click", () => {
        state.role = btn.dataset.roleBtn;
        updateRoleUI();
        setStatus(
          "–†–æ–ª—å –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∞ –Ω–∞: " + state.role,
          "–í—Å–µ –¥–µ–π—Å—Ç–≤–∏—è —Ç–µ–ø–µ—Ä—å –±—É–¥—É—Ç –ø–æ–º–µ—á–µ–Ω—ã —ç—Ç–æ–π —Ä–æ–ª—å—é –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –±–æ—Ç–∞."
        );
      });
    });

    updateRoleUI();

    // ------------------------------
    //  –£–¢–ò–õ–ò–¢–ê –û–¢–ü–†–ê–í–ö–ò –î–ê–ù–ù–´–• –ë–û–¢–£
    // ------------------------------
    function sendPayload(payload) {
      const full = {
        role: state.role,
        lectureId: state.lectureId,
        ...payload,
      };

      if (!tg) {
        console.log("Payload (–±–µ–∑ Telegram):", full);
        alert(
          "WebApp –æ—Ç–∫—Ä—ã—Ç –≤–Ω–µ Telegram. –í –±–æ—é sendData —É–π–¥—ë—Ç –±–æ—Ç—É.\n\n" +
            JSON.stringify(full, null, 2)
        );
        return;
      }
      tg.sendData(JSON.stringify(full));
    }

    // ------------------------------
    //  –ü–ê–ù–ï–õ–¨ –°–¢–£–î–ï–ù–¢–ê
    // ------------------------------

    // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–æ—Ñ–∏–ª—è
    $("btnStudentRegister").addEventListener("click", () => {
      const fio = $("studentFio").value.trim();
      const email = $("studentEmail").value.trim();

      if (!fio || !email) {
        setStatus(
          "–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –§–ò–û –∏ –ø–æ—á—Ç—É.",
          "–ü–æ–ª—è ¬´–§–∞–º–∏–ª–∏—è –ò–º—è –û—Ç—á–µ—Å—Ç–≤–æ¬ª –∏ ¬´–ü–æ—á—Ç–∞ @edu.mirea.ru¬ª –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã."
        );
        return;
      }

      sendPayload({
        type: "register",
        fio,
        email,
      });

      setStatus(
        "–ü—Ä–æ—Ñ–∏–ª—å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é.",
        "–ë–æ—Ç –ø—Ä–æ–≤–µ—Ä–∏—Ç –ø–æ—á—Ç—É, —Å–æ–∑–¥–∞—Å—Ç/–æ–±–Ω–æ–≤–∏—Ç –∑–∞–ø–∏—Å—å –∏ —Å–≤—è–∂–µ—Ç –µ—ë —Å –≤–∞—à–∏–º Telegram ID."
      );
    });

    // –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ QR –ª–µ–∫—Ü–∏–∏
    $("btnStudentScanQR").addEventListener("click", () => {
      if (!tg || !tg.scanQrPopup) {
        alert("QR-—Å–∫–∞–Ω–µ—Ä Telegram –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –≤ —ç—Ç–æ–º –æ–∫—Ä—É–∂–µ–Ω–∏–∏.");
        return;
      }

      tg.scanQrPopup(
        {
          text: "–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ –ª–µ–∫—Ü–∏–∏",
        },
        (result) => {
          state.lectureId = result;
          $("studentLectureInfo").textContent =
            "–¢–µ–∫—É—â–∞—è –ª–µ–∫—Ü–∏—è: " + result + " (–∑–Ω–∞—á–µ–Ω–∏–µ –ø–µ—Ä–µ–¥–∞–Ω–æ –±–æ—Ç—É).";

          sendPayload({
            type: "qr_scan",
            qr: result,
          });

          setStatus(
            "QR-–∫–æ–¥ –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω.",
            "ID –ª–µ–∫—Ü–∏–∏ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –≤–∞—à–µ–º—É —Å–µ–∞–Ω—Å—É –≤ –º–∏–Ω–∏-–∞–ø–ø–µ."
          );
        }
      );
    });

    // LIVE GEO (watchPosition)
    function startGeoStream() {
      if (!navigator.geolocation) {
        setStatus(
          "–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è.",
          "–ë—Ä–∞—É–∑–µ—Ä/–∫–ª–∏–µ–Ω—Ç –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç navigator.geolocation."
        );
        return;
      }
      if (state.geoWatchId !== null) {
        setStatus(
          "–¢—Ä–∞–Ω—Å–ª—è—Ü–∏—è —É–∂–µ –≤–∫–ª—é—á–µ–Ω–∞.",
          "–ú—ã —É–∂–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –≤–∞—à—É –ø–æ–∑–∏—Ü–∏—é –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–æ—Ç—É."
        );
        return;
      }

      const watchId = navigator.geolocation.watchPosition(
        (pos) => {
          const { latitude, longitude, accuracy } = pos.coords;
          const ts = Date.now();
          state.lastGeo = { latitude, longitude, accuracy, ts };

          // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–∞–∂–¥–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∫ "live –≥–µ–æ"
          sendPayload({
            type: "geo_stream",
            lat: latitude,
            lon: longitude,
            accuracy,
            timestamp: ts,
          });

          $("geoStatusMain").textContent =
            "–¢—Ä–∞–Ω—Å–ª—è—Ü–∏—è –≤–∫–ª—é—á–µ–Ω–∞. –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã.";
          $("geoStatusLast").textContent =
            "–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: " +
            new Date(ts).toLocaleTimeString() +
            ` (lat=${latitude.toFixed(5)}, lon=${longitude.toFixed(5)}, ¬±${Math.round(
              accuracy
            )} –º)`;
        },
        (err) => {
          console.error("Geolocation error:", err);
          setStatus(
            "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≥–µ–æ–ø–æ–∑–∏—Ü–∏—é.",
            "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é –≤ Telegram/–±—Ä–∞—É–∑–µ—Ä–µ."
          );
          stopGeoStream();
        },
        {
          enableHighAccuracy: true,
          maximumAge: 5000,
          timeout: 10000,
        }
      );

      state.geoWatchId = watchId;
      $("btnGeoStart").disabled = true;
      $("btnGeoStop").disabled = false;
      $("geoStatusMain").textContent =
        "–¢—Ä–∞–Ω—Å–ª—è—Ü–∏—è –≤–∫–ª—é—á–µ–Ω–∞, –∂–¥—ë–º –ø–µ—Ä–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç...";
      $("geoStatusLast").textContent = "–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: ‚Äî";
    }

    function stopGeoStream() {
      if (state.geoWatchId !== null) {
        navigator.geolocation.clearWatch(state.geoWatchId);
        state.geoWatchId = null;
      }
      $("btnGeoStart").disabled = false;
      $("btnGeoStop").disabled = true;
      $("geoStatusMain").textContent = "–¢—Ä–∞–Ω—Å–ª—è—Ü–∏—è –≤—ã–∫–ª—é—á–µ–Ω–∞.";
      $("geoStatusLast").textContent = "–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: ‚Äî";
    }

    $("btnGeoStart").addEventListener("click", startGeoStream);
    $("btnGeoStop").addEventListener("click", stopGeoStream);

    // –û—Ç–º–µ—Ç–∏—Ç—å—Å—è
    $("btnStudentCheckin").addEventListener("click", () => {
      const fio = $("studentFio").value.trim();
      const email = $("studentEmail").value.trim();

      sendPayload({
        type: "checkin",
        fio,
        email,
        lastGeo: state.lastGeo || null,
      });

      setStatus(
        "–ó–∞–ø—Ä–æ—Å –Ω–∞ –æ—Ç–º–µ—Ç–∫—É –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω.",
        "–ë–æ—Ç –ø—Ä–æ–≤–µ—Ä–∏—Ç QR, –≥–µ–æ–∑–æ–Ω—É, —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∏ —Ä–µ—à–∏—Ç, –∑–∞—Å—á–∏—Ç—ã–≤–∞—Ç—å –ª–∏ –ø–æ—Å–µ—â–µ–Ω–∏–µ."
      );
    });

    // ------------------------------
    //  –ü–ê–ù–ï–õ–¨ –°–ü–ò–ö–ï–†–ê
    // ------------------------------
    $("btnSpeakerOpenLecture").addEventListener("click", () => {
      const id = $("speakerLectureId").value.trim();
      if (!id) {
        setStatus("–£–∫–∞–∂–∏—Ç–µ ID –ª–µ–∫—Ü–∏–∏.", "–ù–∞–ø—Ä–∏–º–µ—Ä, LEC123.");
        return;
      }
      state.lectureId = id;
      sendPayload({
        type: "speaker_open_lecture",
        lectureId: id,
      });
      setStatus(
        "–õ–µ–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∞ –¥–ª—è –æ—Ç–º–µ—Ç–æ–∫.",
        "–ë–æ—Ç –Ω–∞—á–Ω—ë—Ç –ø—Ä–∏–Ω–∏–º–∞—Ç—å –æ—Ç–º–µ—Ç–∫–∏ –ø–æ —ç—Ç–æ–º—É ID –∏ QR-–∫–æ–¥—É."
      );
    });

    $("btnSpeakerCloseLecture").addEventListener("click", () => {
      const id = $("speakerLectureId").value.trim() || state.lectureId;
      sendPayload({
        type: "speaker_close_lecture",
        lectureId: id,
      });
      setStatus(
        "–õ–µ–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∞.",
        "–ù–æ–≤—ã–µ –æ—Ç–º–µ—Ç–∫–∏ –ø–æ —ç—Ç–æ–π –ª–µ–∫—Ü–∏–∏ –ø—Ä–∏–Ω–∏–º–∞—Ç—å—Å—è –Ω–µ –±—É–¥—É—Ç."
      );
    });

    $("btnSpeakerSetGeo").addEventListener("click", () => {
      if (!navigator.geolocation) {
        setStatus(
          "–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è.",
          "–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –∑–∞–¥–∞—Ç—å –≥–µ–æ–∑–æ–Ω—É –∞—É–¥–∏—Ç–æ—Ä–∏–∏."
        );
        return;
      }
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const { latitude, longitude, accuracy } = pos.coords;
          sendPayload({
            type: "speaker_set_geo",
            lat: latitude,
            lon: longitude,
            accuracy,
          });
          setStatus(
            "–ì–µ–æ–∑–æ–Ω–∞ –ª–µ–∫—Ü–∏–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞.",
            `–¶–µ–Ω—Ç—Ä: lat=${latitude.toFixed(
              5
            )}, lon=${longitude.toFixed(5)}, ¬±${Math.round(accuracy)} –º.`
          );
        },
        (err) => {
          console.error(err);
          setStatus(
            "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≥–µ–æ–ø–æ–∑–∏—Ü–∏—é.",
            "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é."
          );
        },
        {
          enableHighAccuracy: true,
          maximumAge: 5000,
          timeout: 10000,
        }
      );
    });

    // ------------------------------
    //  –ü–ê–ù–ï–õ–¨ –ê–î–ú–ò–ù–ê
    // ------------------------------
    $("btnAdminSetRole").addEventListener("click", () => {
      const uid = $("adminTargetUserId").value.trim();
      const role = $("adminTargetRole").value;
      if (!uid) {
        setStatus(
          "–£–∫–∞–∂–∏—Ç–µ Telegram user_id.",
          "–≠—Ç—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –º–æ–∂–Ω–æ –≤–∑—è—Ç—å –∏–∑ –ª–æ–≥–æ–≤ –±–æ—Ç–∞."
        );
        return;
      }
      sendPayload({
        type: "admin_set_role",
        targetUserId: uid,
        newRole: role,
      });
      setStatus(
        "–ó–∞–ø—Ä–æ—Å –Ω–∞ —Å–º–µ–Ω—É —Ä–æ–ª–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω.",
        `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${uid} ‚Üí —Ä–æ–ª—å ${role}.`
      );
    });

    $("btnAdminRequestStats").addEventListener("click", () => {
      const id = $("adminStatsLectureId").value.trim();
      if (!id) {
        setStatus(
          "–£–∫–∞–∂–∏—Ç–µ ID –ª–µ–∫—Ü–∏–∏ –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.",
          "–ù–∞–ø—Ä–∏–º–µ—Ä, LEC123 –∏–ª–∏ –¥—Ä—É–≥–æ–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä."
        );
        return;
      }
      sendPayload({
        type: "admin_request_stats",
        lectureId: id,
      });
      setStatus(
        "–ó–∞–ø—Ä–æ—Å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω.",
        "–ë–æ—Ç –º–æ–∂–µ—Ç –ø—Ä–∏—Å–ª–∞—Ç—å –∏—Ç–æ–≥–∏ –≤ —á–∞—Ç, Google Sheets –∏–ª–∏ –¥—Ä—É–≥–∏–º —Å–ø–æ—Å–æ–±–æ–º."
      );
    });
  </script>
</body>
</html>