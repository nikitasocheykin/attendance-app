<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>MIREA Attendance Mini App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Telegram WebApp JS -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    .tg-warning-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.96);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #e5e7eb;
      padding: 1.5rem;
      z-index: 9999;
      text-align: center;
    }
  </style>
</head>
<body class="bg-slate-950 min-h-screen flex justify-center">
  <!-- –û–≤–µ—Ä–ª–µ–π, –µ—Å–ª–∏ –ù–ï Telegram -->
  <div id="notTelegramOverlay" class="tg-warning-overlay hidden">
    <h2 class="text-xl font-bold mb-2">–û—Ç–∫—Ä–æ–π —á–µ—Ä–µ–∑ Telegram</h2>
    <p class="text-sm text-slate-300 mb-4 max-w-md">
      –≠—Ç–æ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ Telegram WebApp.<br/>
      –û—Ç–∫—Ä–æ–π –±–æ—Ç–∞ –∏ –Ω–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É <b>¬´–û—Ç–∫—Ä—ã—Ç—å –º–∏–Ω–∏-–∞–ø–ø—É¬ª</b> –∏–ª–∏ –∫–Ω–æ–ø–∫—É –≤ –∫–æ–º–∞–Ω–¥–∞—Ö.
    </p>
    <p class="text-xs text-slate-500">
      –í –æ–±—ã—á–Ω–æ–º –±—Ä–∞—É–∑–µ—Ä–µ –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç Telegram API (—Å–∫–∞–Ω–µ—Ä QR, –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, secure initData).
    </p>
  </div>

  <div
    id="app"
    class="w-full max-w-lg px-4 py-6 sm:px-6 sm:py-8 text-slate-50 font-sans"
  >
    <!-- HEADER -->
    <header class="mb-6">
      <h1 class="text-2xl font-bold tracking-tight mb-1">
        MIREA Attendance
      </h1>
      <p class="text-sm text-slate-300">
        –ú–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –æ—Ç–º–µ—Ç–æ–∫ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏.
      </p>

      <div
        id="userInfo"
        class="mt-4 flex items-center justify-between bg-slate-900/60 border border-slate-800 rounded-xl px-3 py-2 text-xs"
      >
        <div>
          <div id="tgName" class="font-semibold">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å Telegram</div>
          <div id="tgUid" class="text-slate-400">ID: ‚Äî</div>
        </div>
        <span
          id="tgRoleLabel"
          class="inline-flex items-center px-2 py-1 rounded-full text-[10px] font-semibold bg-sky-500/10 text-sky-300 border border-sky-500/40"
        >
          –†–µ–∂–∏–º: —Å—Ç—É–¥–µ–Ω—Ç
        </span>
      </div>
    </header>

    <!-- STATUS BAR -->
    <section
      id="statusBar"
      class="mb-4 bg-slate-900/60 border border-slate-800 rounded-2xl px-3 py-2 text-xs text-slate-300"
    >
      <div id="statusMain" class="font-semibold text-slate-100">
        –ì–æ—Ç–æ–≤–æ –∫ —Ä–∞–±–æ—Ç–µ.
      </div>
      <div id="statusSecondary" class="text-[11px] text-slate-400 mt-1">
        –í–µ—Å—å –¥–æ—Å—Ç—É–ø —Ä–µ–∞–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –±–æ—Ç–∞. –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å ‚Äî —Ç–æ–ª—å–∫–æ UI.
      </div>
    </section>

    <!-- MAIN CONTENT -->
    <main class="space-y-4 mb-8">

      <!-- STUDENT PANEL -->
      <section
        id="panel-student"
        class="bg-slate-900/80 border border-slate-800 rounded-2xl p-4 space-y-4"
      >
        <h2 class="text-sm font-semibold text-slate-100 mb-1">
          –ü–∞–Ω–µ–ª—å —Å—Ç—É–¥–µ–Ω—Ç–∞
        </h2>
        <p class="text-xs text-slate-400 mb-2">
          –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å, –ø—Ä–∏–≤—è–∂–∏—Ç–µ—Å—å –∫ –ª–µ–∫—Ü–∏–∏, –≤–∫–ª—é—á–∏—Ç–µ —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏—é
          –≥–µ–æ–ø–æ–∑–∏—Ü–∏–∏ –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –æ—Ç–º–µ—Ç–∫—É.
        </p>

        <!-- –ü—Ä–æ—Ñ–∏–ª—å -->
        <div class="space-y-2">
          <h3 class="text-xs font-semibold text-slate-300">
            –ü—Ä–æ—Ñ–∏–ª—å –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
          </h3>
          <input
            id="studentFio"
            type="text"
            placeholder="–§–∞–º–∏–ª–∏—è –ò–º—è –û—Ç—á–µ—Å—Ç–≤–æ"
            class="w-full rounded-xl border border-slate-700 bg-slate-950/60 px-3 py-2 text-xs placeholder:text-slate-500 focus:outline-none focus:ring-1 focus:ring-sky-500"
          />
          <input
            id="studentEmail"
            type="email"
            placeholder="–ü–æ—á—Ç–∞ @edu.mirea.ru"
            class="w-full rounded-xl border border-slate-700 bg-slate-950/60 px-3 py-2 text-xs placeholder:text-slate-500 focus:outline-none focus:ring-1 focus:ring-sky-500"
          />
          <button
            id="btnStudentRegister"
            class="w-full mt-1 inline-flex justify-center items-center gap-1 rounded-xl bg-sky-500 hover:bg-sky-600 text-xs font-semibold py-2.5"
          >
            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å / –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
          </button>
        </div>

        <hr class="border-slate-800 my-2" />

        <!-- QR –∏ –ª–µ–∫—Ü–∏—è -->
        <div class="space-y-2">
          <h3 class="text-xs font-semibold text-slate-300">
            QR-–∫–æ–¥ –ª–µ–∫—Ü–∏–∏
          </h3>
          <button
            id="btnStudentScanQR"
            class="w-full inline-flex justify-center items-center gap-2 rounded-xl bg-purple-600 hover:bg-purple-700 text-xs font-semibold py-2.5"
          >
            üì∑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR –ª–µ–∫—Ü–∏–∏
          </button>
          <p
            id="studentLectureInfo"
            class="text-[11px] text-slate-400 mt-1 break-words"
          >
            –õ–µ–∫—Ü–∏—è –µ—â—ë –Ω–µ –≤—ã–±—Ä–∞–Ω–∞. –û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ –ª–µ–∫—Ü–∏–∏ –≤–Ω—É—Ç—Ä–∏ Telegram.
          </p>
        </div>

        <hr class="border-slate-800 my-2" />

        <!-- Live GEO -->
        <div class="space-y-2">
          <h3 class="text-xs font-semibold text-slate-300">
            –¢—Ä–∞–Ω—Å–ª—è—Ü–∏—è –≥–µ–æ–ø–æ–∑–∏—Ü–∏–∏ (live)
          </h3>
          <p class="text-[11px] text-slate-400">
            –ü—Ä–∏ –≤–∫–ª—é—á–µ–Ω–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è <b>watchPosition()</b> –∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
            –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –±–æ—Ç—É. –≠—Ç–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø—Ä–∏–±–ª–∏–∂–µ–Ω–æ
            –∫ —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏–∏ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏.
          </p>

          <div class="flex gap-2">
            <button
              id="btnGeoStart"
              class="flex-1 inline-flex justify-center items-center gap-1 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-xs font-semibold py-2.5 disabled:bg-emerald-900/60 disabled:text-emerald-200/60"
            >
              ‚ñ∂Ô∏è –í–∫–ª—é—á–∏—Ç—å —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏—é
            </button>
            <button
              id="btnGeoStop"
              class="flex-1 inline-flex justify-center items-center gap-1 rounded-xl bg-rose-600 hover:bg-rose-700 text-xs font-semibold py-2.5 disabled:bg-rose-900/60 disabled:text-rose-200/60"
              disabled
            >
              ‚èπ –í—ã–∫–ª—é—á–∏—Ç—å
            </button>
          </div>

          <div
            id="geoStatusBox"
            class="mt-1 text-[11px] text-slate-400 space-y-0.5"
          >
            <div id="geoStatusMain">–¢—Ä–∞–Ω—Å–ª—è—Ü–∏—è –≤—ã–∫–ª—é—á–µ–Ω–∞.</div>
            <div id="geoStatusLast">–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: ‚Äî</div>
          </div>
        </div>

        <hr class="border-slate-800 my-2" />

        <!-- –û—Ç–º–µ—Ç–∏—Ç—å—Å—è -->
        <div class="space-y-2">
          <h3 class="text-xs font-semibold text-slate-300">
            –û—Ç–º–µ—Ç–∏—Ç—å—Å—è –Ω–∞ –ª–µ–∫—Ü–∏–∏
          </h3>
          <button
            id="btnStudentCheckin"
            class="w-full inline-flex justify-center items-center gap-1 rounded-xl bg-blue-600 hover:bg-blue-700 text-xs font-semibold py-2.5"
          >
            ‚úÖ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–º–µ—Ç–∫—É
          </button>
          <p class="text-[11px] text-slate-400">
            –û—Ç–º–µ—Ç–∫–∞ —É–π–¥—ë—Ç –±–æ—Ç—É –≤–º–µ—Å—Ç–µ —Å –§–ò–û, –ø–æ—á—Ç–æ–π, ID –ª–µ–∫—Ü–∏–∏ –∏ –ø–æ—Å–ª–µ–¥–Ω–µ–π
            –≥–µ–æ–ø–æ–∑–∏—Ü–∏–µ–π (–µ—Å–ª–∏ —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏—è –≤–∫–ª—é—á–µ–Ω–∞).
          </p>
        </div>
      </section>

      <!-- SPEAKER PANEL -->
      <section
        id="panel-speaker"
        class="hidden bg-slate-900/80 border border-slate-800 rounded-2xl p-4 space-y-4"
      >
        <h2 class="text-sm font-semibold text-slate-100 mb-1">
          –ü–∞–Ω–µ–ª—å —Å–ø–∏–∫–µ—Ä–∞
        </h2>
        <p class="text-xs text-slate-400 mb-2">
          –û—Ç–∫—Ä—ã–≤–∞–π—Ç–µ/–∑–∞–∫—Ä—ã–≤–∞–π—Ç–µ –ª–µ–∫—Ü–∏–∏, –∑–∞–¥–∞–≤–∞–π—Ç–µ –≥–µ–æ–∑–æ–Ω—É –∞—É–¥–∏—Ç–æ—Ä–∏–∏.
        </p>

        <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª–µ–∫—Ü–∏–µ–π -->
        <div class="space-y-2">
          <h3 class="text-xs font-semibold text-slate-300">–õ–µ–∫—Ü–∏—è</h3>
          <input
            id="speakerLectureId"
            type="text"
            placeholder="ID –ª–µ–∫—Ü–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, LEC123)"
            class="w-full rounded-xl border border-slate-700 bg-slate-950/60 px-3 py-2 text-xs placeholder:text-slate-500 focus:outline-none focus:ring-1 focus:ring-sky-500"
          />
          <div class="flex gap-2">
            <button
              id="btnSpeakerOpenLecture"
              class="flex-1 inline-flex justify-center items-center gap-1 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-xs font-semibold py-2.5"
            >
              üîì –û—Ç–∫—Ä—ã—Ç—å –æ—Ç–º–µ—Ç–∫—É
            </button>
            <button
              id="btnSpeakerCloseLecture"
              class="flex-1 inline-flex justify-center items-center gap-1 rounded-xl bg-rose-600 hover:bg-rose-700 text-xs font-semibold py-2.5"
            >
              üîí –ó–∞–∫—Ä—ã—Ç—å
            </button>
          </div>
        </div>

        <hr class="border-slate-800 my-2" />

        <!-- –ì–µ–æ–∑–æ–Ω–∞ -->
        <div class="space-y-2">
          <h3 class="text-xs font-semibold text-slate-300">
            –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –ª–µ–∫—Ü–∏–∏
          </h3>
          <button
            id="btnSpeakerSetGeo"
            class="w-full inline-flex justify-center items-center gap-1 rounded-xl bg-indigo-600 hover:bg-indigo-700 text-xs font-semibold py-2.5"
          >
            üìç –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≥–µ–æ–∑–æ–Ω—É –ø–æ —Ç–µ–∫—É—â–µ–π –ø–æ–∑–∏—Ü–∏–∏
          </button>
          <p class="text-[11px] text-slate-400">
            –û–¥–Ω–æ—Ä–∞–∑–æ–≤–æ –±–µ—Ä—ë–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏—Ö –±–æ—Ç—É –∫–∞–∫ —Ü–µ–Ω—Ç—Ä –¥–æ–ø—É—Å—Ç–∏–º–æ–≥–æ
            —Ä–∞–¥–∏—É—Å–∞.
          </p>
        </div>
      </section>

      <!-- ADMIN PANEL -->
      <section
        id="panel-admin"
        class="hidden bg-slate-900/80 border border-slate-800 rounded-2xl p-4 space-y-4"
      >
        <h2 class="text-sm font-semibold text-slate-100 mb-1">
          –ü–∞–Ω–µ–ª—å –º–∞—Å—Ç–µ—Ä-–∞–¥–º–∏–Ω–∞
        </h2>
        <p class="text-xs text-slate-400 mb-2">
          –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–æ–ª—è–º–∏ –∏ –∑–∞–ø—Ä–æ—Å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏.
        </p>

        <div class="space-y-2">
          <h3 class="text-xs font-semibold text-slate-300">
            –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–æ–ª—è–º–∏
          </h3>
          <input
            id="adminTargetUserId"
            type="number"
            placeholder="Telegram user_id"
            class="w-full rounded-xl border border-slate-700 bg-slate-950/60 px-3 py-2 text-xs placeholder:text-slate-500 focus:outline-none focus:ring-1 focus:ring-sky-500"
          />
          <select
            id="adminTargetRole"
            class="w-full rounded-xl border border-slate-700 bg-slate-950/60 px-3 py-2 text-xs focus:outline-none focus:ring-1 focus:ring-sky-500"
          >
            <option value="student">student</option>
            <option value="speaker">speaker</option>
            <option value="rating">rating</option>
            <option value="admin">admin</option>
          </select>
          <button
            id="btnAdminSetRole"
            class="w-full inline-flex justify-center items-center gap-1 rounded-xl bg-sky-500 hover:bg-sky-600 text-xs font-semibold py-2.5"
          >
            üë§ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
          </button>
        </div>

        <hr class="border-slate-800 my-2" />

        <div class="space-y-2">
          <h3 class="text-xs font-semibold text-slate-300">
            –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ª–µ–∫—Ü–∏–∏
          </h3>
          <input
            id="adminStatsLectureId"
            type="text"
            placeholder="ID –ª–µ–∫—Ü–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, LEC123)"
            class="w-full rounded-xl border border-slate-700 bg-slate-950/60 px-3 py-2 text-xs placeholder:text-slate-500 focus:outline-none focus:ring-1 focus:ring-sky-500"
          />
          <button
            id="btnAdminRequestStats"
            class="w-full inline-flex justify-center items-center gap-1 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-xs font-semibold py-2.5"
          >
            üìä –ó–∞–ø—Ä–æ—Å–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏
          </button>
        </div>
      </section>
    </main>

    <!-- FOOTER -->
    <footer class="text-[10px] text-slate-500 text-center">
      –í—Å–µ —Ä–µ–∞–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ (—Ä–æ–ª–∏, –≥–µ–æ–∑–æ–Ω–∞, —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å, QR) –¥–µ–ª–∞–µ—Ç –±–æ—Ç.
    </footer>
  </div>

  <script>
    // ------------------------------
    //  –ü–û–î–ì–û–¢–û–í–ö–ê
    // ------------------------------
    const tg = window.Telegram?.WebApp || null;

    const $ = (id) => document.getElementById(id);

    function setStatus(main, secondary) {
      if (main) $("statusMain").textContent = main;
      if (secondary) $("statusSecondary").textContent = secondary;
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–∞–ø—É—â–µ–Ω–æ –≤ Telegram
    function ensureTelegramEnv() {
      if (!tg || !tg.initDataUnsafe || !tg.initData) {
        document.getElementById("notTelegramOverlay").classList.remove("hidden");
        // –ë–ª–æ–∫–∏—Ä—É–µ–º –æ—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
        document.getElementById("app").classList.add("opacity-20");
        return false;
      }
      document.getElementById("notTelegramOverlay").classList.add("hidden");
      document.getElementById("app").classList.remove("opacity-20");
      return true;
    }

    const inTelegram = ensureTelegramEnv();

    if (inTelegram) {
      tg.ready();
      tg.expand();
    }

    // ------------------------------
    //  –†–ï–ñ–ò–ú (student / speaker / admin)
    // ------------------------------
    const params = new URLSearchParams(window.location.search);
    let uiMode = (params.get("mode") || "student").toLowerCase();
    if (!["student", "speaker", "admin"].includes(uiMode)) {
      uiMode = "student";
    }

    function updateModeUI() {
      $("panel-student").classList.add("hidden");
      $("panel-speaker").classList.add("hidden");
      $("panel-admin").classList.add("hidden");

      if (uiMode === "student") {
        $("panel-student").classList.remove("hidden");
      } else if (uiMode === "speaker") {
        $("panel-speaker").classList.remove("hidden");
      } else if (uiMode === "admin") {
        $("panel-admin").classList.remove("hidden");
      }

      const label = uiMode === "student"
        ? "–†–µ–∂–∏–º: —Å—Ç—É–¥–µ–Ω—Ç"
        : uiMode === "speaker"
        ? "–†–µ–∂–∏–º: —Å–ø–∏–∫–µ—Ä (UI)"
        : "–†–µ–∂–∏–º: –º–∞—Å—Ç–µ—Ä-–∞–¥–º–∏–Ω (UI)";

      $("tgRoleLabel").textContent = label;
    }

    updateModeUI();

    // ------------------------------
    //  –ò–ù–§–ê –û –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï
    // ------------------------------
    if (inTelegram) {
      const u = tg.initDataUnsafe.user;
      if (u) {
        $("tgName").textContent = (u.first_name || "") + " " + (u.last_name || "");
        $("tgUid").textContent = "ID: " + u.id;
      }
    }

    // ------------------------------
    //  –û–¢–ü–†–ê–í–ö–ê PAYLOAD –ë–û–¢–£
    // ------------------------------
    function sendPayload(payload) {
      const full = {
        ...payload,
        lectureId: state.lectureId,
        mode: uiMode, // –ø—Ä–æ—Å—Ç–æ –¥–ª—è –ª–æ–≥–æ–≤ –Ω–∞ –±—ç–∫–µ
      };

      if (!inTelegram) {
        console.log("Payload (no Telegram):", full);
        alert(
          "WebApp –æ—Ç–∫—Ä—ã—Ç –≤–Ω–µ Telegram. –í –±–æ—é sendData —É–π–¥—ë—Ç –±–æ—Ç—É.\n\n" +
            JSON.stringify(full, null, 2)
        );
        return;
      }
      tg.sendData(JSON.stringify(full));
    }

    const state = {
      lectureId: null,
      geoWatchId: null,
      lastGeo: null,
    };

    // ------------------------------
    //  –°–¢–£–î–ï–ù–¢: –ü–†–û–§–ò–õ–¨
    // ------------------------------
    $("btnStudentRegister").addEventListener("click", () => {
      const fio = $("studentFio").value.trim();
      const email = $("studentEmail").value.trim();

      if (!fio || !email) {
        setStatus(
          "–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –§–ò–û –∏ –ø–æ—á—Ç—É.",
          "–ü–æ–ª—è ¬´–§–∞–º–∏–ª–∏—è –ò–º—è –û—Ç—á–µ—Å—Ç–≤–æ¬ª –∏ ¬´–ü–æ—á—Ç–∞ @edu.mirea.ru¬ª –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã."
        );
        return;
      }

      sendPayload({
        type: "register",
        fio,
        email,
      });

      setStatus(
        "–ü—Ä–æ—Ñ–∏–ª—å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ.",
        "–ë–æ—Ç —Å–≤—è–∂–µ—Ç –µ–≥–æ —Å –≤–∞—à–∏–º Telegram ID."
      );
    });

    // ------------------------------
    //  –°–¢–£–î–ï–ù–¢: QR
    // ------------------------------
    $("btnStudentScanQR").addEventListener("click", () => {
      if (!inTelegram || !tg.scanQrPopup) {
        setStatus(
          "QR-—Å–∫–∞–Ω–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.",
          "–û—Ç–∫—Ä–æ–π –º–∏–Ω–∏-–∞–ø–ø—É –≤–Ω—É—Ç—Ä–∏ Telegram –Ω–∞ –º–æ–±–∏–ª—å–Ω–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ."
        );
        return;
      }

      tg.scanQrPopup(
        { text: "–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ –ª–µ–∫—Ü–∏–∏" },
        (result) => {
          state.lectureId = result;
          $("studentLectureInfo").textContent =
            "–¢–µ–∫—É—â–∞—è –ª–µ–∫—Ü–∏—è: " + result + " (ID –ø–µ—Ä–µ–¥–∞–Ω –±–æ—Ç—É).";

          sendPayload({
            type: "qr_scan",
            qr: result,
          });

          setStatus(
            "QR-–∫–æ–¥ –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω.",
            "–õ–µ–∫—Ü–∏—è –ø—Ä–∏–≤—è–∑–∞–Ω–∞ –∫ –≤–∞—à–µ–º—É —Å–µ–∞–Ω—Å—É. –ë–æ—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ —ç—Ç–æ –≤–∞–ª–∏–¥–Ω—ã–π ID."
          );
        }
      );
    });

    // ------------------------------
    //  –°–¢–£–î–ï–ù–¢: LIVE GEO
    // ------------------------------
    function startGeoStream() {
      if (!navigator.geolocation) {
        setStatus(
          "–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è.",
          "–ë—Ä–∞—É–∑–µ—Ä/–∫–ª–∏–µ–Ω—Ç –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç navigator.geolocation."
        );
        return;
      }
      if (state.geoWatchId !== null) {
        setStatus(
          "–¢—Ä–∞–Ω—Å–ª—è—Ü–∏—è —É–∂–µ –≤–∫–ª—é—á–µ–Ω–∞.",
          "–ú—ã —É–∂–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –≤–∞—à—É –ø–æ–∑–∏—Ü–∏—é –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–æ—Ç—É."
        );
        return;
      }

      const watchId = navigator.geolocation.watchPosition(
        (pos) => {
          const { latitude, longitude, accuracy } = pos.coords;
          const ts = Date.now();
          state.lastGeo = { latitude, longitude, accuracy, ts };

          sendPayload({
            type: "geo_stream",
            lat: latitude,
            lon: longitude,
            accuracy,
            timestamp: ts,
          });

          $("geoStatusMain").textContent =
            "–¢—Ä–∞–Ω—Å–ª—è—Ü–∏—è –≤–∫–ª—é—á–µ–Ω–∞. –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã.";
          $("geoStatusLast").textContent =
            "–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: " +
            new Date(ts).toLocaleTimeString() +
            ` (lat=${latitude.toFixed(5)}, lon=${longitude.toFixed(5)}, ¬±${Math.round(
              accuracy
            )} –º)`;
        },
        (err) => {
          console.error("Geolocation error:", err);
          setStatus(
            "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≥–µ–æ–ø–æ–∑–∏—Ü–∏—é.",
            "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é –≤ Telegram."
          );
          stopGeoStream();
        },
        {
          enableHighAccuracy: true,
          maximumAge: 5000,
          timeout: 10000,
        }
      );

      state.geoWatchId = watchId;
      $("btnGeoStart").disabled = true;
      $("btnGeoStop").disabled = false;
      $("geoStatusMain").textContent =
        "–¢—Ä–∞–Ω—Å–ª—è—Ü–∏—è –≤–∫–ª—é—á–µ–Ω–∞, –∂–¥—ë–º –ø–µ—Ä–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç...";
      $("geoStatusLast").textContent = "–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: ‚Äî";
    }

    function stopGeoStream() {
      if (state.geoWatchId !== null) {
        navigator.geolocation.clearWatch(state.geoWatchId);
        state.geoWatchId = null;
      }
      $("btnGeoStart").disabled = false;
      $("btnGeoStop").disabled = true;
      $("geoStatusMain").textContent = "–¢—Ä–∞–Ω—Å–ª—è—Ü–∏—è –≤—ã–∫–ª—é—á–µ–Ω–∞.";
      $("geoStatusLast").textContent = "–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: ‚Äî";
    }

    $("btnGeoStart").addEventListener("click", startGeoStream);
    $("btnGeoStop").addEventListener("click", stopGeoStream);

    // ------------------------------
    //  –°–¢–£–î–ï–ù–¢: –û–¢–ú–ï–¢–ö–ê
    // ------------------------------
    $("btnStudentCheckin").addEventListener("click", () => {
      const fio = $("studentFio").value.trim();
      const email = $("studentEmail").value.trim();

      sendPayload({
        type: "checkin",
        fio,
        email,
        lastGeo: state.lastGeo || null,
      });

      setStatus(
        "–ó–∞–ø—Ä–æ—Å –Ω–∞ –æ—Ç–º–µ—Ç–∫—É –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω.",
        "–ë–æ—Ç –ø—Ä–æ–≤–µ—Ä–∏—Ç QR, –≥–µ–æ–∑–æ–Ω—É, —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (–Ω–∞ —Å–≤–æ–µ–π —Å—Ç–æ—Ä–æ–Ω–µ)."
      );
    });

    // ------------------------------
    //  –°–ü–ò–ö–ï–†
    // ------------------------------
    $("btnSpeakerOpenLecture").addEventListener("click", () => {
      const id = $("speakerLectureId").value.trim();
      if (!id) {
        setStatus("–£–∫–∞–∂–∏—Ç–µ ID –ª–µ–∫—Ü–∏–∏.", "–ù–∞–ø—Ä–∏–º–µ—Ä, LEC123.");
        return;
      }
      state.lectureId = id;
      sendPayload({
        type: "speaker_open_lecture",
        lectureId: id,
      });
      setStatus(
        "–õ–µ–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∞ (–∑–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω).",
        "–ë–æ—Ç –ø—Ä–æ–≤–µ—Ä–∏—Ç –≤–∞—à–∏ –ø—Ä–∞–≤–∞ —Å–ø–∏–∫–µ—Ä–∞."
      );
    });

    $("btnSpeakerCloseLecture").addEventListener("click", () => {
      const id = $("speakerLectureId").value.trim() || state.lectureId;
      sendPayload({
        type: "speaker_close_lecture",
        lectureId: id,
      });
      setStatus(
        "–õ–µ–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∞ (–∑–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω).",
        "–†–µ—à–µ–Ω–∏–µ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –±–æ—Ç."
      );
    });

    $("btnSpeakerSetGeo").addEventListener("click", () => {
      if (!navigator.geolocation) {
        setStatus(
          "–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è.",
          "–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –∑–∞–¥–∞—Ç—å –≥–µ–æ–∑–æ–Ω—É –∞—É–¥–∏—Ç–æ—Ä–∏–∏."
        );
        return;
      }
      const id = $("speakerLectureId").value.trim() || state.lectureId;
      if (!id) {
        setStatus(
          "–£–∫–∞–∂–∏—Ç–µ ID –ª–µ–∫—Ü–∏–∏ –¥–ª—è –≥–µ–æ–∑–æ–Ω—ã.",
          "–í –ø–∞–Ω–µ–ª–∏ —Å–ø–∏–∫–µ—Ä–∞ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª–µ ID –ª–µ–∫—Ü–∏–∏."
        );
        return;
      }
      state.lectureId = id;

      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const { latitude, longitude, accuracy } = pos.coords;
          sendPayload({
            type: "speaker_set_geo",
            lectureId: id,
            lat: latitude,
            lon: longitude,
            accuracy,
          });
          setStatus(
            "–ì–µ–æ–∑–æ–Ω–∞ –ª–µ–∫—Ü–∏–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞.",
            `–¶–µ–Ω—Ç—Ä: lat=${latitude.toFixed(
              5
            )}, lon=${longitude.toFixed(5)}, ¬±${Math.round(accuracy)} –º.`
          );
        },
        (err) => {
          console.error(err);
          setStatus(
            "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≥–µ–æ–ø–æ–∑–∏—Ü–∏—é.",
            "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é."
          );
        },
        {
          enableHighAccuracy: true,
          maximumAge: 5000,
          timeout: 10000,
        }
      );
    });

    // ------------------------------
    //  –ê–î–ú–ò–ù
    // ------------------------------
    $("btnAdminSetRole").addEventListener("click", () => {
      const uid = $("adminTargetUserId").value.trim();
      const role = $("adminTargetRole").value;
      if (!uid) {
        setStatus(
          "–£–∫–∞–∂–∏—Ç–µ Telegram user_id.",
          "–≠—Ç—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –º–æ–∂–Ω–æ –≤–∑—è—Ç—å –∏–∑ –ª–æ–≥–æ–≤ –±–æ—Ç–∞."
        );
        return;
      }

      sendPayload({
        type: "admin_set_role",
        targetUserId: uid,
        newRole: role,
      });

      setStatus(
        "–ó–∞–ø—Ä–æ—Å –Ω–∞ —Å–º–µ–Ω—É —Ä–æ–ª–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω.",
        `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${uid} ‚Üí —Ä–æ–ª—å ${role}.`
      );
    });

    $("btnAdminRequestStats").addEventListener("click", () => {
      const id = $("adminStatsLectureId").value.trim();
      if (!id) {
        setStatus(
          "–£–∫–∞–∂–∏—Ç–µ ID –ª–µ–∫—Ü–∏–∏ –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.",
          "–ù–∞–ø—Ä–∏–º–µ—Ä, LEC123."
        );
        return;
      }
      sendPayload({
        type: "admin_request_stats",
        lectureId: id,
      });
      setStatus(
        "–ó–∞–ø—Ä–æ—Å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω.",
        "–ë–æ—Ç –ø—Ä–∏—à–ª—ë—Ç —Å–≤–æ–¥–∫—É –≤ —á–∞—Ç."
      );
    });
  </script>
</body>
</html>
